<!doctype html>
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js lt-ie9 lt-ie8" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js lt-ie9" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
    <meta charset="utf-8">
    <meta name="theme-color" content="#5b7c89">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Модели &mdash; Silex-MVC</title>
        <meta name="viewport" content="width=device-width,initial-scale=1">
    <!--<link rel="icon" href="/silex-mvc/favicon.ico">-->
    <link rel="stylesheet" href="/silex-mvc/components/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="/silex-mvc/css/style.css?v=6">
    <link rel="stylesheet" href="/silex-mvc/components/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/silex-mvc/components/highlightjs/styles/github.css" />
    
    <link rel="apple-touch-icon" sizes="57x57" href="/silex-mvc/images/silex/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/silex-mvc/images/silex/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/silex-mvc/images/silex/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/silex-mvc/images/silex/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/silex-mvc/images/silex/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/silex-mvc/images/silex/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/silex-mvc/images/silex/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/silex-mvc/images/silex/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/silex-mvc/images/silex/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="/silex-mvc/images/silex/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/silex-mvc/images/silex/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/silex-mvc/images/silex/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/silex-mvc/images/silex/favicon-16x16.png">
    <link rel="manifest" href="/silex-mvc/images/silex/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/silex-mvc/images/silex/ms-icon-144x144.png">
    
</head>
<body>
    <a class="fork-me-on-github" href="https://github.com/bsa-git/silex-mvc/" target="_blank"><img src="/silex-mvc/assets/right-red@2x.png" alt="Fork me on GitHub"></a>
    <header class="site">
        <nav class="navbar navbar-default navbar-static-top" role="navigation">
            <div class="container">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <div class="site-mascot" title="Silex-MVC"></div>
                    <a class="navbar-brand" href="/silex-mvc/ru/">Silex-MVC</a>
                </div>
                <div class="collapse navbar-collapse navbar-ex1-collapse">
                    <ul class="nav navbar-nav">
                        <li >
                            <a href="/silex-mvc/ru/">Главная</a>
                        </li>
                        <li >
                            <a href="/silex-mvc/ru/getstarted/">Начало работы</a>
                        </li>
                        <li >
                            <a href="/silex-mvc/ru/download/">Загрузить</a>
                        </li>
                        <li >
                            <a href="/silex-mvc/ru/documentation/">Документация</a>
                        </li>
                        <li >
                            <a href="/silex-mvc/ru/community/">Сообщество</a>
                        </li>
                                            </ul>
                </div>
            </div>
        </nav>
    </header>
        <section class="content">
        <div class="container">
                <div class="row">
        <div class="col-sm-3">
            <div class="sculpin-sidebar">
                <ul class="nav">
                                            <li ><a href="/silex-mvc/ru/getstarted/">Начало работы</a>
                                                    </li>
                                            <li ><a href="/silex-mvc/ru/documentation/basic-project/">Базовый проект</a>
                                                    </li>
                                            <li ><a href="/silex-mvc/ru/documentation/configuration/">Конфигурация</a>
                                                    </li>
                                            <li ><a href="/silex-mvc/ru/documentation/web-app">Веб приложение (app)</a>
                                                            <ul class="nav">
                                                                                <li ><a href="/silex-mvc/ru/documentation/web-app/bootstrap/">Загрузчик (Bootstrap.php)</a>
                                                                                <li ><a href="/silex-mvc/ru/documentation/web-app/controllers/">Контроллеры</a>
                                                                                <li ><a href="/silex-mvc/ru/documentation/web-app/forms/">Формы</a>
                                                                                <li  class="active" ><a href="/silex-mvc/ru/documentation/web-app/models/">Модели</a>
                                                                                <li ><a href="/silex-mvc/ru/documentation/web-app/services/">Сервисы</a>
                                                                                <li ><a href="/silex-mvc/ru/documentation/web-app/layouts/">Макеты</a>
                                                                                <li ><a href="/silex-mvc/ru/documentation/web-app/locale/">Локализация</a>
                                                                                <li ><a href="/silex-mvc/ru/documentation/web-app/security/">Безопасность</a>
                                                                    </ul>
                                                    </li>
                                            <li ><a href="/silex-mvc/ru/documentation/web-public">Веб приложение (public)</a>
                                                            <ul class="nav">
                                                                                <li ><a href="/silex-mvc/ru/documentation/web-public/main/">Загрузчик (main.js)</a>
                                                                                <li ><a href="/silex-mvc/ru/documentation/web-public/locale/">Локализация</a>
                                                                                <li ><a href="/silex-mvc/ru/documentation/web-public/services/">Сервисы</a>
                                                                                <li ><a href="/silex-mvc/ru/documentation/web-public/backbone/">Backbone</a>
                                                                    </ul>
                                                    </li>
                                            <li ><a href="/silex-mvc/ru/documentation/console-app">Консольное приложение</a>
                                                            <ul class="nav">
                                                                                <li ><a href="/silex-mvc/ru/documentation/console-app/bootstrap/">Загрузчик (Bootstrap.php)</a>
                                                                                <li ><a href="/silex-mvc/ru/documentation/console-app/configuration/">Конфигурация</a>
                                                                                <li ><a href="/silex-mvc/ru/documentation/console-app/lifecycle/">Жизненный цикл</a>
                                                                    </ul>
                                                    </li>
                                    </ul>
            </div>
        </div>
        <div class="col-sm-9">
            <h1>Модели</h1>
            <p>Это набор классов, который обеспечивает работу с базой данных.</p>

<p>Для тестирования и проверки реализовано три технологии работы с базой данных:</p>

<ul>
<li><strong>Doctrine(<a href="http://docs.doctrine-project.org/projects/doctrine-dbal/en/latest/index.html">DBAL</a>)</strong> <code>vendor/doctrine</code></li>
<li><strong>Doctrine(<a href="http://docs.doctrine-project.org/projects/doctrine-orm/en/latest/index.html">ORM</a>)</strong> <code>vendor/doctrine</code></li>
<li><strong>PHP <a href="http://www.phpactiverecord.org/">ActiveRecord</a></strong> <code>library/AR</code></li>
</ul>

<p>Рассмотрим основные возможности этих технологий на основе создания нового сообщения (поста).</p>

<p>Для работы с базами данных создан набор классов в папке <code>app/Models/</code> доступ к которым 
обеспечивается провайдером <code>app/Providers/ModelsServiceProvider.php</code> с помощью метода <code>load</code>.</p>

<pre><code>public function load($modelName, $modelMethod = null, $data = array()) {
    if (isset($this-&gt;app["models.{$modelName}"])) {
        $Model = $this-&gt;app["models.{$modelName}"];
    } else {
        $modelClass = "\\Models\\{$modelName}Model";
        $Model = new $modelClass();
        $Model-&gt;setApp($this-&gt;app);
        $this-&gt;app["models.{$modelName}"] = $Model;
    }
    return $Model-&gt;$modelMethod($data);
}
</code></pre>

<p>В нашем случае мы будем использовать класс модели <strong>PostModel</strong> <code>app/Models/PostModel.php</code> для 
работы с таблицей <code>post</code> в базе данных <code>app/Resources/db/app.db</code>.</p>

<p>Пример такого обращения к модели можно видеть здесь.</p>

<pre><code>// Create new post
$models-&gt;load('Post', 'newPost', array('username' =&gt; $username, 'new_post' =&gt; $ormPost));
</code></pre>

<h2 id="doctrinedbal">Doctrine(<a href="http://docs.doctrine-project.org/projects/doctrine-dbal/en/latest/index.html">DBAL</a>)</h2>

<p>Пример добавления записи в таблицу <code>post</code> с помощью метода <code>newPost</code> класса <strong>PostModel</strong>
<code>app/Models/PostModel.php</code> можно видеть здесь.</p>

<pre><code>/**
 * newPost
 * Add post for current user
 * 
 * @param array $data
 * @return void
 */
public function newPost($data) {
    $db = $this-&gt;app['db'];
    //--------------------

    $username = $data['username'];
    $ormPost = $data['new_post'];
    // Transform the date to format 'Y-m-d'
    $date = new \DateTime($ormPost-&gt;getCreated());
    $ormPost-&gt;setCreated($date-&gt;format('Y-m-d'));
    $arrPost = $ormPost-&gt;getValues();

    // Get user's id
    $sql = "SELECT * FROM user WHERE username = ?";
    $user = $db-&gt;fetchAssoc($sql, array($username));
    if ($user === FALSE) {
        $this-&gt;app-&gt;abort(404, "Not find user for this username \"{$username}\"");
    }
    $arrPost['user_id'] = $user['id'];
    $db-&gt;insert('post', $arrPost);
}
</code></pre>

<p>Здесь переменная <code>$ormPost</code> является объектом данных класса <strong>Post</strong> <code>app/Models/ORM/Post.php</code>, 
который создан на основе <strong>Doctrine(DBAL)</strong> технологии.</p>

<p>Примеры объектов данных для работы с таблицами базы данных <code>app/Resources/db/app.db</code> 
можно посмотреть здесь <code>app/Models/DBAL/</code>.</p>

<p>Примеры работы с базой данных с помощью консольных команд можно посмотреть здесь <code>app/Cosole/Commands/DBAL/</code>.</p>

<h2 id="doctrineorm">Doctrine(<a href="http://docs.doctrine-project.org/projects/doctrine-orm/en/latest/index.html">ORM</a>)</h2>

<p>Пример получения всех сообщений (постов) для пользователя из таблицы <code>post</code> 
с помощью метода <code>getPostsForUser</code> класса <strong>PostModel</strong> 
<code>app/Models/PostModel.php</code> можно видеть здесь.</p>

<pre><code>/**
 * getPostsForUser
 * Get posts for user
 * 
 * @param string $userName
 * @return array
 */
public function getPostsForUser($userName) {
    $em = $this-&gt;app['em'];
    $repo = $em-&gt;getRepository('Models\ORM\User');
    //--------------------
    $user = $repo-&gt;findOneByUsername($userName);

    if ($user === NULL) {
        $this-&gt;app-&gt;abort(404, "Not find user for this username \"{$userName}\"");
    }
    $posts = $user-&gt;getPosts();

    // Data for user's posts
    $data = array('username' =&gt; $user-&gt;getUsername(), 'posts' =&gt; $posts-&gt;toArray());

    return $data;
}
</code></pre>

<p>Примеры объектов данных для работы с таблицами базы данных <code>app/Resources/db/app.db</code> 
можно помотреть здесь <code>app/Models/ORM/</code>.</p>

<p>Примеры работы с базой данных с помощью консольных команд можно посмотреть здесь <code>app/Cosole/Commands/ORM/</code>.</p>

<h2 id="php-activerecord">PHP <a href="http://www.phpactiverecord.org/">ActiveRecord</a></h2>

<p>Пример получения всех сообщений (постов) из таблицы <code>post</code> 
с помощью метода <code>postsAction</code> класса <strong>TestController</strong>
<code>app/Controllers/TestController.php</code> можно видеть здесь.</p>

<pre><code>/**
 * Action - test/posts
 * receive posts written by the user
 * 
 * @param string $userName 
 * @param int $page 
 * @return string
 */
public function postsAction($userName, $page) {
    $app = $this-&gt;app;
    $db = $this-&gt;app['ar'];
    //--------------------
    try {
        ...
        // Get posts
        if ($userName) {
            ...
        } else {
            $posts = array();
            // Get user's posts
            $users = $db-&gt;find('user', 'all', array('select' =&gt; 'id, username'));
            foreach ($users as $user) {
                $posts[$user-&gt;username] = $user-&gt;post;
            }
            // Data for user's posts
            $data = array('posts' =&gt; $posts);
        }
        return $this-&gt;showView($data);
    } catch (\Exception $exc) {
        return $this-&gt;showError($exc);
    }
}
</code></pre>

<p>Доступ к работе с этим примером возможен в меню <strong>Testing/PHP ActiveRecord/User posts</strong>, 
если вы зайдете в приложение как <strong>Admin</strong>.</p>

<p>Примеры объектов данных для работами с таблицами базы данных <code>app/Resources/db/app.db</code> 
можно помотреть здесь <code>app/Models/AR/</code>.</p>
        </div>
    </div>
        </div>
    </section>
    <footer class="site">
        <div class="container">
                            <div class="mascot">
                    <a class="ir" href="https://sculpin.io/" target="_blank" title="Сайт создан с помощью Sculpin - статического генератора сайтов"></a>
                </div>
                <div class="social">
                    <ul>
                        <li>
                            <a href="http://silex.sensiolabs.org/contributors" target="_blank" title="Silex разработчики"><span class="glyphicon glyphicon-edit" aria-hidden="true"></span></a>
                        </li>
                        <li>
                            <a href="http://symfony.com/blog/" target="_blank" title="Symfony блог"><span class="glyphicon glyphicon-user" aria-hidden="true"></span></a>
                        </li>
                        <li>
                            <a href="http://symfony.com/community" target="_blank" title="Symfony сообщество" ><span class="glyphicon glyphicon-comment" aria-hidden="true"></span></a>
                        </li>
                    </ul>
                </div>
                <div class="copyright">
                    &copy;2016 <a href="https://github.com/bsa-git/" target="_blank">Сергей Бескоровайный</a>
                    (<a href="mailto:bsa2657@jandex.ru?subject=Silex-MVC">Email</a>)
                </div>
                    </div>
    </footer>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="/silex-mvc/components/jquery/jquery.min.js"><\/script>')</script>
    <script defer src="/silex-mvc/components/bootstrap/js/bootstrap.min.js"></script>
</body>
</html>
